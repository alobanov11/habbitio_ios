# Техническая документация приложения Habbitio

## Общая архитектура и бизнес-логика

### Описание приложения
Habbitio - это iOS приложение для отслеживания привычек, разработанное на SwiftUI с использованием SwiftData для хранения данных. Приложение позволяет пользователям создавать, отслеживать и анализировать выполнение своих привычек с поддержкой уведомлений, архивирования и статистики.

### Основные технологии
- **Framework**: SwiftUI
- **База данных**: SwiftData
- **Уведомления**: UserNotifications Framework
- **Виджеты**: WidgetKit
- **Архитектура**: MVVM
- **Минимальная версия iOS**: iOS 17.0+ (требование SwiftData)

## Модель данных (SwiftData)

### Model "Habit" (Привычка)
Основная модель для хранения информации о привычках:

**Свойства:**
- `title: String` - название привычки (2-16 символов, уникальное)
- `category: String?` - категория привычки (опционально)
- `createdDate: Date` - дата создания
- `days: [String]?` - дни недели для выполнения (массив коротких названий дней)
- `isArchived: Bool` - флаг архивирования (по умолчанию false)
- `isRemainderOn: Bool` - включены ли напоминания (по умолчанию false)
- `notifications: [String]?` - идентификаторы уведомлений
- `reminderDate: Date?` - время напоминания
- `reminderText: String?` - текст напоминания

**Связи:**
- `records: [Record]` - записи о выполнении (one-to-many, cascade delete)

### Model "Record" (Запись о выполнении)
Хранит информацию о выполнении привычки в конкретный день:

**Свойства:**
- `date: Date` - дата записи
- `done: Bool` - выполнена ли привычка (по умолчанию false)
- `isEnabled: Bool` - активна ли привычка в этот день (по умолчанию true)

**Связи:**
- `habit: Habit?` - связанная привычка (many-to-one)
- `report: Report?` - связанный отчет (many-to-one)

### Model "Report" (Отчет)
Группирует записи за один день для расчета общей статистики:

**Свойства:**
- `date: Date` - дата отчета

**Связи:**
- `records: [Record]` - записи за день (one-to-many, nullify delete)

## Расширения модели

### Habit Extensions
Добавляет метод для расчета процента выполнения привычки:
```swift
func rate(for number: Int) -> Double
```
Возвращает отношение выполненных записей к общему количеству записей за последние `number` дней.

### Report Extensions
Добавляет свойства для работы со статистикой отчетов:
- `rate: Double` - процент выполнения всех привычек за день
- `static func rateByWeekdays(_:) -> [Double]` - статистика по дням недели

## Экраны приложения

### 1. HabitListView (Главный экран)

**Назначение:** Главный экран приложения, отображающий список активных привычек в виде сетки.

**Ключевые компоненты:**
- `@Environment(\.modelContext)` - SwiftData контекст
- `@State private var records: [Record]` - массив записей о привычках за текущий день
- `@State private var sheetRoute: SheetRoute?` - управление модальными окнами

**Бизнес-логика:**

1. **Загрузка данных (`obtainRecords`)**:
   - Использует `FetchDescriptor<Habit>` с предикатом для неархивированных привычек
   - Использует `FetchDescriptor<Report>` для загрузки отчетов
   - Создает или находит отчет за текущий день
   - Для каждой привычки создает или находит запись за сегодня
   - Устанавливает `isEnabled` в зависимости от дней недели привычки

2. **Группировка по категориям**:
   - Records группируются по категориям в `gridView`
   - Категории сортируются в алфавитном порядке (по убыванию)
   - Пустые категории скрываются

3. **Взаимодействие с привычками**:
   - **Tap** - открывает экран редактирования
   - **Long press** - переключает статус выполнения
   - Анимация масштабирования при нажатии

4. **Навигация**:
   - Кнопка "Archive" -> `ArchiveView`
   - Кнопка "Add habit" -> `HabitEditView` (создание)
   - Кнопка "Stats" -> `StatsView`

**Особенности UI:**
- Сетка 3x3 с `LazyVGrid`
- Адаптивная прозрачность (0.5 для неактивных/выполненных)
- Зеленая граница для выполненных привычек
- Уведомление об изменениях через `NotificationCenter`
- Использует `@Bindable` для Record вместо `@ObservedObject`

### 2. HabitEditView (Создание/редактирование привычки)

**Назначение:** Экран для создания новой привычки или редактирования существующей.

**Ключевые компоненты:**
- `var habit: Habit?` - редактируемая привычка (nil для создания новой)
- `@Environment(\.modelContext)` - SwiftData контекст
- `@State` переменные для всех полей формы
- `@FocusState private var focusedField: Field?` - управление фокусом

**Поля формы:**
1. **Название (title)** - обязательное, максимум 16 символов
2. **Категория (category)** - опциональное, максимум 16 символов
3. **Дни недели (days)** - множественный выбор из дней недели
4. **Напоминания (reminder)** - toggle + время + текст

**Бизнес-логика создания/сохранения:**

1. **Создание/обновление привычки**:
   - Создает новый `Habit` через инициализатор или обновляет существующий
   - Вставляет новую привычку в контекст через `modelContext.insert()`
   - Устанавливает все поля из состояния формы
   - `createdDate` устанавливается автоматически в инициализаторе

2. **Управление уведомлениями**:
   - Удаляет существующие уведомления
   - Если напоминания включены:
     - Создает `UNMutableNotificationContent`
     - Для каждого выбранного дня недели создает `UNCalendarNotificationTrigger`
     - Регистрирует уведомления в системе
     - Сохраняет идентификаторы в `habit.notifications`

3. **Удаление привычки**:
   - Устанавливает `isArchived = true` вместо физического удаления
   - Отключает напоминания
   - Удаляет все связанные уведомления

**Валидация:**
- Название не может быть пустым
- При включенных напоминаниях текст напоминания обязателен
- Ограничение на длину полей (16 символов)

### 3. ArchiveView (Архив привычек)

**Назначение:** Отображение архивированных привычек с возможностью восстановления или окончательного удаления.

**Ключевые компоненты:**
- `@Query` с фильтром `#Predicate<Habit> { $0.isArchived == true }`
- Сортировка по дате создания
- `@Environment(\.modelContext)` - SwiftData контекст

**Функциональность:**
1. **Восстановление (`undo`)**:
   - Устанавливает `isArchived = false`
   - Сохраняет изменения через `modelContext.save()`
   - Отправляет уведомление об изменениях

2. **Окончательное удаление (`delete`)**:
   - Полностью удаляет привычку через `modelContext.delete()`
   - Сохраняет изменения
   - Отправляет уведомление об изменениях

### 4. StatsView (Статистика)

**Назначение:** Отображение статистики выполнения привычек в виде графиков.

**Ключевые компоненты:**
- `@Query(sort: \.date)` для отчетов
- `@Query(filter: #Predicate<Habit> { $0.isArchived == false })` для активных привычек
- `@State private var period: Period` - выбранный период анализа

**Периоды анализа:**
- Week (7 дней)
- Month (30 дней)
- Year (365 дней)
- All (все данные)

**Типы графиков:**

1. **Линейный график по времени**:
   - Ось X: даты
   - Ось Y: общий процент выполнения за день
   - Использует `reports.suffix(period.rawValue)`

2. **Столбчатый график по дням недели**:
   - Ось X: дни недели (сокращенные названия)
   - Ось Y: средний процент выполнения
   - Использует `Report.rateByWeekdays()`

3. **Столбчатый график по привычкам**:
   - Ось X: названия привычек
   - Ось Y: процент выполнения за выбранный период
   - Использует `habit.rate(for: period.rawValue)`

## Система уведомлений

### Архитектура уведомлений
- Использует `UserNotifications` framework
- Запрос разрешений при первом появлении экранов
- Календарные триггеры для повторяющихся уведомлений

### Логика создания уведомлений
1. При сохранении привычки удаляются все существующие уведомления
2. Если напоминания включены:
   - Для каждого выбранного дня недели создается отдельное уведомление
   - `weekday` в `DateComponents` начинается с 1 (воскресенье)
   - Уведомления повторяются еженедельно
3. Идентификаторы сохраняются в `habit.notifications`

## Виджет (HabbitioWidget)

### Назначение
Отображает тепловую карту активности за последние 49 дней (7x7 сетка).

### Компоненты
- `Provider: TimelineProvider` - поставщик данных для виджета
- `Entry: TimelineEntry` - структура данных виджета
- `HabbitioWidgetEntryView` - UI виджета

### Логика работы
1. **Получение данных (`fetchActivity`)**:
   - Использует `FetchDescriptor<Report>` для загрузки отчетов
   - Создает словарь [Date: Double] для всех дней за последние 49 дней
   - Заполняет данными из существующих отчетов
   - Возвращает массив значений, отсортированный по дате

2. **Отображение**:
   - Сетка 7x7 из `RoundedRectangle`
   - Цвет зависит от значения: серый (0) или зеленый с прозрачностью
   - Обновление каждые 5 минут

## Утилиты и расширения

### DispatchQueue Extensions
- `onMainThread()` - выполнение на главном потоке
- `onMainThreadAsync()` - асинхронное выполнение
- `onMainThreadAsync(_:_:)` - с задержкой
- `onBackgroundThread()` - выполнение в фоне

### View Extensions
- `onBackground()` - реакция на уход в фон
- `onForeground()` - реакция на возврат из фона
- `hidden(_:)` - условное скрытие

### Error Handling
- `UnknownError` - обертка для ошибок SwiftData
- Специальная обработка `DataError.duplicatedKey`

## Persistence Layer

### DataManager
- Singleton для управления SwiftData stack
- Поддержка App Groups для совместного доступа с виджетом
- URL хранилища: `group.ru.alobanov11.habbitio`
- Preview экземпляр с тестовыми данными
- `@MainActor` для безопасности UI

### Стратегия данных
- Мягкое удаление через `isArchived`
- Ежедневное создание Record для каждой Habit
- Автоматическое создание Report за текущий день
- Каскадное удаление Record при удалении Habit

## Паттерны и архитектурные решения

### MVVM Pattern
- View (SwiftUI Views)
- Model (SwiftData models с встроенными вычисляемыми свойствами)
- Логика в View слое

### Координация между экранами
- `NotificationCenter` для уведомления об изменениях
- Глобальное имя уведомления: "changes"
- Все экраны подписаны на это уведомление

### State Management
- `@State` для локального состояния
- `@Query` для данных SwiftData
- `@Environment(\.modelContext)` для контекста
- `@Bindable` для наблюдения за изменениями SwiftData моделей

### Анимации
- Spring анимации для взаимодействий
- `.easeInOut` для переходов
- Кастомные анимации масштабирования

## Миграция с Core Data на SwiftData

### Выполненные изменения:
1. **Модели данных**:
   - Создан `Models.swift` с `@Model` классами
   - Перенесены все атрибуты и связи
   - Встроены расширения для вычислений

2. **Замена контроллера**:
   - `PersistenceController` заменен на `DataManager`
   - Настроена поддержка App Groups
   - Добавлена поддержка preview данных

3. **Обновление UI**:
   - `@FetchRequest` заменен на `@Query`
   - `@Environment(\.managedObjectContext)` на `@Environment(\.modelContext)`
   - `@ObservedObject` на `@Bindable`
   - `FetchRequest` на `FetchDescriptor`

4. **Обновление операций**:
   - `Habit(context:)` на `Habit()` + `modelContext.insert()`
   - `viewContext.save()` на `modelContext.save()`
   - `viewContext.delete()` на `modelContext.delete()`

5. **Обновление виджета**:
   - `NSManagedObjectContext` на `ModelContext`
   - Core Data fetch requests на SwiftData FetchDescriptor

### Преимущества миграции:
- Более простой и читаемый код
- Автоматическая генерация моделей
- Лучшая интеграция со SwiftUI
- Современный API для работы с данными
- Типобезопасные предикаты